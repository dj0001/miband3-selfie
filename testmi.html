<!DOCTYPE html>
<html lang="en">
<head>
<meta charset=UTF-8 />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="Description" content="take photo with miband4">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" sizes="192x192" href="favicon.png">
<title>Mi Band 4</title>
<style>

</style>
</head>

<body>
test
<button id='st'>search</button>
<script>
/*
Make sure you are wearing the hr monitor, as it typically
goes to sleep when inactive, not allowing you to connect to it.
Instructions
===
1. Using Google Chrome, open the dev console and paste the below code.
2. A panel near the address bar will open, searching for nearby bluetooth (ble)
   heart rate devices. Don't click away from the panel or Chrome will cancel the search.
3. When found, click connect on your device.
4. An event listener will be added to start capturing the hr data.
   You can refresh the browser if you need to disconnect or cancel the streaming data.
The value will be a DataView.
developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView
Pass the index of the hr, (2nd item in the Array buffer): val.getInt8(1)
*/

const connect = async props => {
  console.clear()
  const device = await navigator.bluetooth.requestDevice({
    filters: [{ services: [0xFEE0] }, { services: ['heart_rate'] }],  //heart_rate
    optionalServices:['heart_rate'],  //,'00002a37-0000-1000-8000-00805f9b34fb'
    acceptAllDevices: false,  //true not with filters
  })
  console.log(`%c\n👩🏼‍⚕️`, 'font-size: 82px;', 'Starting HR...\n\n')
  const server = await device.gatt.connect(),
    service = await server.getPrimaryService('heart_rate'),  //'heart_rate'
    char = await service.getCharacteristic('heart_rate_measurement')

  char.oncharacteristicvaluechanged = props.onChange
  char.startNotifications()
  return char
}

const data = []

st.onclick=function() {
connect({
  onChange: e => {
    const val = e.target.value.getInt8(1)
    data.push(val / 2)
    let arr = data.slice(-200)
    if (arr.length < 200) {
      const fill = []
      let n = 200 - arr.length
      while (n--) fill.push(arr[0])
      arr = fill.concat(arr)
    }
    console.clear()
    console.graph(arr)
    console.log(`%c\n💚 ${val}`, 'font-size: 24px;')
    st.textContent= val  //show on mobile
  },
}).catch(e => console.warn(Error(e)))
}

/**
 * Grapher lib (only for creating an example chart in the console)
 */
;(function() {
  if (!window.console || !window.console.log) return
  var canvas,
    context,
    height = 100,
    width = 400
  canvas = document.createElement('canvas')
  canvas.height = height + ''
  canvas.width = width + ''
  context = canvas.getContext('2d')
  document.body.appendChild(canvas)
  canvas.style.cssText = 'position: absolute; left: -99999px'
  context.fillStyle = '#fff'
  var _graph = function(imageURL, height, width) {
    console.log(
      '%c ',
      '' +
        'font-size: 0;' +
        'padding-left: ' +
        width +
        'px;' +
        'padding-bottom: ' +
        height +
        'px;' +
        'background: url("' +
        imageURL +
        '"),' +
        '-webkit-linear-gradient(#eee, #888);' +
        ''
    )
  }
  window.console.graph = function(data) {
    var units = Math.floor(width / data.length)
    width = units * data.length
    context.clearRect(0, 0, width, height)
    for (var i = 0; i < data.length; i++) {
      context.fillRect(i * units, 0, units, 100 - data[i])
    }
    _graph(canvas.toDataURL(), height, width)
  }
})()
</script>

</html>
